{% extends 'base/base.html' %}
{% load static %}

{% block title %}Início – MotoTec{% endblock title %}

{% block content %}
<!-- 1. Seção Hero (compacta) -->
<section class="bg-white px-4 pt-4 pb-2 shadow-sm">
  <div class="max-w-md mx-auto text-center">
    <h1 class="text-lg sm:text-xl font-bold text-mototec-teal mb-1">
      Bem‐vindo ao MotoTec
    </h1>
    <p class="text-gray-700 text-xs sm:text-sm mb-3">
      Veja a demanda em Praia Grande e encontre rotas rápidas.
    </p>

    {% if not user.is_authenticated %}
      <div class="flex justify-center space-x-2">
        <a href="{% url 'login' %}"
           class="px-2 py-1 bg-mototec-azul text-white text-xs font-medium rounded-md hover:bg-indigo-700 transition">
          Entrar
        </a>
        <a href="{% url 'cadastro' %}"
           class="px-2 py-1 border border-mototec-azul text-mototec-azul text-xs font-medium rounded-md hover:bg-mototec-azul hover:text-white transition">
          Criar conta
        </a>
      </div>
    {% else %}
      <p class="text-green-600 text-sm font-semibold">
        Olá, {{ user.username }}! Abaixo está o mapa.
      </p>
    {% endif %}
  </div>
</section>

<!-- 2. Seção Mapa (altura fixa menor) -->
<section class="relative bg-mototec-bege">
  <div class="w-full h-[250px] sm:h-[350px] md:h-[450px] lg:h-[550px] relative mx-auto">
    <div id="map" class="w-full h-full"></div>

    {% if not user.is_authenticated %}
      <!-- Overlay bloqueando interação: ocupa todo o mapa -->
      <div class="absolute inset-0 bg-black bg-opacity-70 flex flex-col items-center justify-center text-white text-center px-4">
        <p class="text-base font-medium mb-2">Faça login para acessar o heatmap.</p>
        <div class="flex space-x-2">
          <a href="{% url 'login' %}"
             class="px-3 py-1 bg-mototec-azul text-white text-xs font-medium rounded-md hover:bg-indigo-700 transition">
            Entrar
          </a>
          <a href="{% url 'cadastro' %}"
             class="px-3 py-1 border border-white text-white text-xs font-medium rounded-md hover:bg-white hover:text-mototec-teal transition">
            Criar conta
          </a>
        </div>
      </div>
    {% endif %}

    {% if user.is_authenticated %}
      <!-- Botão “Focar em Praia Grande” sobre o mapa -->
      <button id="focusPraiaGrande"
              class="absolute bottom-4 right-4 z-20 bg-white border border-mototec-teal text-mototec-teal text-xs px-2 py-1 rounded-full shadow hover:bg-mototec-teal hover:text-white transition">
        ➤ Focar Praia Grande
      </button>
    {% endif %}
  </div>
</section>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  <!-- Leaflet CSS/JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-heat@0.2.0/dist/leaflet-heat.js"></script>

  {% if user.is_authenticated %}
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Inicializa o mapa, definindo vista inicial em Praia Grande
      const map = L.map("map", {
        zoomControl: false  // remove botões de zoom para simplicidade no mobile
      }).setView([-24.0167, -46.4667], 13);

      // Adiciona camada de tiles do OpenStreetMap
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors"
      }).addTo(map);

      // Função para desenhar heatmap
      function atualizarMapa() {
        fetch("/api/demanda/")
          .then(res => res.json())
          .then(data => {
            // Remove marcadores anteriores
            map.eachLayer(layer => {
              if (layer instanceof L.CircleMarker) {
                map.removeLayer(layer);
              }
            });
            // Desenha novos círculos
            if (data.dados && data.dados.length) {
              data.dados.forEach(ponto => {
                let r = Math.min(4 + ponto.restaurantes * 1.5, 18);
                L.circleMarker([ponto.lat, ponto.lng], {
                  radius: r,
                  fillColor: ponto.cor,
                  color: "#000",
                  weight: 1,
                  opacity: 1,
                  fillOpacity: 0.75
                }).addTo(map);
              });
            }
          })
          .catch(e => console.error(e));
      }

      // Carrega inicialmente e depois a cada 30s
      atualizarMapa();
      setInterval(atualizarMapa, 30000);

      // Botão para focar em Praia Grande
      document.getElementById("focusPraiaGrande").addEventListener("click", () => {
        map.setView([-24.0167, -46.4667], 13);
      });
    });
  </script>
  {% endif %}
{% endblock %}
